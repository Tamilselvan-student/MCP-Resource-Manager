<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN CONTROL PANEL</title>

    <!-- Retro Fonts (matching index.html) -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* ================= RESET ================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
        }

        body {
            font-family: 'VT323', monospace;
            background: #0b0b0b;
            color: #d0d0d0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ================= CONTAINER ================= */
        .container {
            width: 100%;
            max-width: 920px;
            background: #111;
            border: 3px solid #2f2f2f;
            box-shadow:
                inset 0 0 0 2px #000,
                0 0 0 4px #1c1c1c;
            animation: flicker 4s infinite;
        }

        @keyframes flicker {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.98;
            }
        }

        /* ================= HEADER ================= */
        .header {
            padding: 20px;
            border-bottom: 2px solid #2a2a2a;
            position: relative;
        }

        .header::after {
            content: "";
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(to bottom,
                    rgba(255, 255, 255, 0.03),
                    rgba(255, 255, 255, 0.03) 1px,
                    transparent 1px,
                    transparent 3px);
            pointer-events: none;
        }

        .header h1 {
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            margin-bottom: 6px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.7;
        }

        .nav-links {
            margin-top: 12px;
            display: flex;
            gap: 10px;
        }

        .nav-links a {
            background: #181818;
            border: 2px solid #333;
            padding: 6px 12px;
            text-decoration: none;
            color: #d0d0d0;
            box-shadow: 2px 2px 0 #000;
            font-size: 14px;
            transition: none;
        }

        .nav-links a:hover {
            background: #222;
        }

        .nav-links a:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* ================= PANEL ================= */
        .panel {
            padding: 20px;
            border-bottom: 2px solid #2a2a2a;
        }

        .panel h2 {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2a2a2a;
        }

        /* ================= FORM ================= */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 6px;
            opacity: 0.7;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            border: 2px solid #333;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        button {
            padding: 10px 18px;
            background: #2d2d2d;
            border: 2px solid #555;
            color: #fff;
            font-family: inherit;
            font-size: 14px;
            box-shadow: 2px 2px 0 #000;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background: #333;
        }

        button:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ================= STATUS MESSAGE ================= */
        .status-message {
            padding: 12px;
            margin-bottom: 16px;
            border: 2px solid;
            font-size: 14px;
            display: none;
            box-shadow: 2px 2px 0 #000;
        }

        .status-message.success {
            background: #1a2a1a;
            border-color: #4a4;
            color: #8f8;
        }

        .status-message.error {
            background: #2a1515;
            border-color: #a44;
            color: #f88;
        }

        .status-message.show {
            display: block;
        }

        /* ================= USER LIST ================= */
        .user-list {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            padding: 12px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .user-list::-webkit-scrollbar {
            width: 8px;
        }

        .user-list::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .user-list::-webkit-scrollbar-thumb {
            background: #333;
        }

        .user-item {
            padding: 8px;
            border-bottom: 1px solid #222;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            flex: 1;
        }

        .user-role {
            opacity: 0.6;
            font-size: 12px;
            margin-left: 8px;
        }

        .delete-btn {
            padding: 4px 10px;
            background: #2a1515;
            border: 2px solid #a44;
            color: #f88;
            font-size: 12px;
            width: auto;
            margin-left: 10px;
        }

        .delete-btn:hover {
            background: #3a1a1a;
        }

        .delete-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .role-select {
            padding: 4px 8px;
            background: #1a1a1a;
            border: 2px solid #333;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 12px;
            margin-left: 10px;
            width: auto;
            cursor: pointer;
        }

        .role-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .role-select:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ADMIN CONTROL</h1>
            <p>User Management System</p>
            <div class="nav-links">
                <a href="/dashboard.html">‚Üê BACK</a>
                <a href="#" onclick="loadUsers(); return false;">REFRESH</a>
            </div>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="panel">
            <h2>+ ADD USER</h2>
            <form onsubmit="addUser(event)">
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="newUserName" placeholder="e.g., John Doe" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="newUserEmail" placeholder="e.g., john@example.com" required>
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select id="newUserRole">
                        <option value="viewer">VIEWER (Read Only)</option>
                        <option value="editor">EDITOR (Read + Write)</option>
                        <option value="admin">ADMIN (Full Control)</option>
                    </select>
                </div>
                <div
                    style="margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; font-size: 12px; color: #888;">
                    ‚ÑπÔ∏è Default password: <strong style="color: #3b82f6;">changeme123</strong><br>
                    User will be prompted to change password on first login.
                </div>
                <button type="submit">CREATE USER</button>
            </form>

            <div class="user-list" id="userList">
                <div class="user-item">Loading users...</div>
            </div>
        </div>
    </div>

    <!-- Admin Management Section (Owner Only) -->
    <div id="adminManagementSection" style="display: none; margin-top: 40px; padding: 20px;">
        <div style="background: #2563eb; color: white; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
            <h2 style="margin: 0; font-family: 'Press Start 2P', monospace; font-size: 14px;">
                ‚ö° ADMIN MANAGEMENT
            </h2>
            <p style="margin: 5px 0 0 0; font-size: 12px;">Grant or revoke admin access (Owner only)</p>
        </div>

        <table
            style="width: 100%; border-collapse: collapse; background: #0f0f0f; border: 2px solid #2563eb; margin-bottom: 30px;">
            <thead>
                <tr style="background: #1a1a1a; border-bottom: 2px solid #2563eb;">
                    <th style="padding: 12px; text-align: left; color: #00ff00;">Username</th>
                    <th style="padding: 12px; text-align: left; color: #00ff00;">Email</th>
                    <th style="padding: 12px; text-align: left; color: #00ff00;">Current Role</th>
                    <th style="padding: 12px; text-align: left; color: #00ff00;">Action</th>
                </tr>
            </thead>
            <tbody id="adminManagementTableBody">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>

        <div style="padding: 20px; background: #1a1a1a; border: 2px solid #2563eb; border-radius: 8px;">
            <h3 style="color: #00ff00; margin-top: 0; font-size: 16px;">üìú ADMIN GRANT HISTORY</h3>
            <div id="adminGrantHistory" style="max-height: 300px; overflow-y: auto;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // ================= AUTHENTICATION CHECK =================
        // Check if user is authenticated and has admin access
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include' // Include cookies
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        const data = await response.json();
                        if (data.mustChangePassword) {
                            window.location.href = '/change-password.html';
                            return false;
                        }
                    }
                    // Not authenticated, redirect to login
                    window.location.href = '/login.html';
                    return false;
                }

                const data = await response.json();

                // Double-check from user data
                if (data.user && data.user.must_change_password) {
                    window.location.href = '/change-password.html';
                    return false;
                }

                // Check if user has admin access
                if (data.user.role !== 'admin' && data.user.role !== 'owner') {
                    alert('Access denied. Admin role required.');
                    window.location.href = '/dashboard.html';
                    return false;
                }

                // Store user info in sessionStorage for UI
                sessionStorage.setItem('currentUser', JSON.stringify(data.user));

                console.log('‚úÖ Authenticated as admin:', data.user.email);
                return true;

            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
                return false;
            }
        }

        // Run auth check immediately
        checkAuth();

        // ================= EXISTING CODE =================
        const protectedUsers = ['user:tharsan', 'user:admin'];

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 5000);
        }

        async function addUser(event) {
            event.preventDefault();

            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            const role = document.getElementById('newUserRole').value;

            // Extract username from email (part before @)
            const username = email.split('@')[0];
            const userId = `user:${username}`;

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId,
                        username,
                        email,
                        name,
                        role
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`USER CREATED: ${name} (${email}) AS ${role.toUpperCase()}`, 'success');
                    document.getElementById('newUserName').value = '';
                    document.getElementById('newUserEmail').value = '';
                    loadUsers();
                } else {
                    showStatus(`ERROR: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`ERROR: ${error.message}`, 'error');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Delete user "${username}"?\n\nThis will revoke all permissions.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${encodeURIComponent(userId)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`USER DELETED: ${username}`, 'success');
                    loadUsers();
                } else {
                    showStatus(`ERROR: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`ERROR: ${error.message}`, 'error');
            }
        }

        async function changeUserRole(userId, newRole) {
            try {
                const response = await fetch(`/api/admin/users/${encodeURIComponent(userId)}/role`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newRole })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`ROLE UPDATED: ${userId} ‚Üí ${newRole.toUpperCase()}`, 'success');
                    loadUsers();
                } else {
                    showStatus(`ERROR: ${result.error}`, 'error');
                    loadUsers(); // Reload to reset dropdown
                }
            } catch (error) {
                showStatus(`ERROR: ${error.message}`, 'error');
                loadUsers(); // Reload to reset dropdown
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const result = await response.json();

                const listEl = document.getElementById('userList');

                if (result.success && result.data.length > 0) {
                    listEl.innerHTML = result.data.map(user => {
                        const isProtected = protectedUsers.includes(user.uuid);
                        const deleteBtn = isProtected
                            ? `<button class="delete-btn" disabled>PROTECTED</button>`
                            : `<button class="delete-btn" onclick="deleteUser('${user.uuid}', '${user.username}')">DELETE</button>`;

                        const roleOptions = ['viewer', 'editor', 'admin'].map(role =>
                            `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role.toUpperCase()}</option>`
                        ).join('');

                        const roleSelect = `<select class="role-select" onchange="changeUserRole('${user.uuid}', this.value)" ${isProtected ? 'disabled' : ''}>${roleOptions}</select>`;

                        return `
                            <div class="user-item">
                                <div class="user-info">
                                    ${user.username} <span class="user-role">(${user.email})</span>
                                </div>
                                ${roleSelect}
                                ${deleteBtn}
                            </div>
                        `;
                    }).join('');
                } else {
                    listEl.innerHTML = '<div class="user-item">No users found</div>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // ================= ADMIN MANAGEMENT (OWNER ONLY) =================

        // Check if current user is owner and show admin management section
        async function initAdminManagement() {
            const response = await fetch('/api/auth/me', { credentials: 'include' });
            const data = await response.json();

            if (data.user && data.user.role === 'owner') {
                document.getElementById('adminManagementSection').style.display = 'block';
                loadAdminManagement();
            }
        }

        async function loadAdminManagement() {
            try {
                // Load users for admin management
                const usersResponse = await fetch('/api/admin/users', { credentials: 'include' });
                const usersData = await usersResponse.json();

                const tbody = document.getElementById('adminManagementTableBody');
                tbody.innerHTML = usersData.data
                    .filter(u => u.role !== 'owner') // Can't modify owner
                    .map(user => `
                        <tr style="border-bottom: 1px solid #2563eb;">
                            <td style="padding: 12px; color: #00ff00;">${user.username}</td>
                            <td style="padding: 12px; color: #00ff00;">${user.email}</td>
                            <td style="padding: 12px;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                    background: ${user.role === 'admin' ? '#ef4444' : user.role === 'editor' ? '#06b6d4' : '#6b7280'}; 
                                    color: white;">
                                    ${user.role.toUpperCase()}
                                </span>
                            </td>
                            <td style="padding: 12px;">
                                ${user.role === 'admin'
                            ? `<button onclick="revokeAdmin('${user.uuid}', '${user.username}')" 
                                         style="background: #dc2626; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 11px; font-family: 'Press Start 2P', monospace;">
                                         REVOKE ADMIN
                                       </button>`
                            : `<button onclick="grantAdmin('${user.uuid}', '${user.username}')" 
                                         style="background: #16a34a; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; font-size: 11px; font-family: 'Press Start 2P', monospace;">
                                         GRANT ADMIN
                                       </button>`
                        }
                            </td>
                        </tr>
                    `).join('');

                // Load grant history
                const historyResponse = await fetch('/api/admin/grant-history', { credentials: 'include' });
                const historyData = await historyResponse.json();

                const historyDiv = document.getElementById('adminGrantHistory');
                if (historyData.history && historyData.history.length > 0) {
                    historyDiv.innerHTML = historyData.history.map(grant => `
                        <div style="padding: 12px; margin-bottom: 10px; background: #0f0f0f; border: 1px solid #2563eb; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: ${grant.action === 'granted' ? '#10b981' : '#ef4444'}; font-weight: bold;">
                                    ${grant.action === 'granted' ? '‚úÖ GRANTED' : '‚ùå REVOKED'}
                                </span>
                                <span style="color: #666; font-size: 12px;">
                                    ${new Date(grant.created_at).toLocaleString()}
                                </span>
                            </div>
                            <div style="color: #00ff00;">
                                <strong>${grant.target_user}</strong>: ${grant.previous_role} ‚Üí ${grant.new_role}
                            </div>
                            <div style="color: #00cc00; font-size: 12px; margin-top: 5px;">
                                By: ${grant.granted_by_user}
                            </div>
                            ${grant.reason ? `<div style="color: #999; font-size: 12px; margin-top: 5px; font-style: italic;">"${grant.reason}"</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No admin grants/revocations yet</p>';
                }

            } catch (error) {
                console.error('Error loading admin management:', error);
            }
        }

        async function grantAdmin(userId, username) {
            const reason = prompt(`Enter reason for granting admin access to ${username}:`);
            if (!reason || reason.trim() === '') {
                alert('Reason is required');
                return;
            }

            try {
                const response = await fetch('/api/admin/grant-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ userId, reason: reason.trim() })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Admin access granted to ${username}`);
                    loadAdminManagement(); // Refresh the table
                    loadUsers(); // Refresh main user list
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error granting admin:', error);
                alert('‚ùå Failed to grant admin access');
            }
        }

        async function revokeAdmin(userId, username) {
            const newRole = prompt(`Enter new role for ${username} after revoking admin (editor or viewer):`);
            if (!newRole || !['editor', 'viewer'].includes(newRole.toLowerCase())) {
                alert('Invalid role. Must be "editor" or "viewer"');
                return;
            }

            const reason = prompt(`Enter reason for revoking admin access from ${username}:`);
            if (!reason || reason.trim() === '') {
                alert('Reason is required');
                return;
            }

            try {
                const response = await fetch('/api/admin/revoke-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId,
                        newRole: newRole.toLowerCase(),
                        reason: reason.trim()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Admin access revoked from ${username}`);
                    loadAdminManagement(); // Refresh the table
                    loadUsers(); // Refresh main user list
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error revoking admin:', error);
                alert('‚ùå Failed to revoke admin access');
            }
        }

        loadUsers();
        initAdminManagement();
    </script>
</body>

</html>